name: Check curl updates

on:
  schedule:
    # Run daily at 10:00 UTC
    - cron: '0 10 * * *'
  workflow_dispatch:
    # Allow manual triggering

jobs:
  check-updates:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup git config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for curl updates
        id: check
        run: |
          # Run checker script (non-interactive mode)
          ./scripts/check-curl-updates.sh || true

          # Extract version info from state file
          if [ -f .curl-upstream-state.json ]; then
            UPSTREAM_VERSION=$(jq -r '.last_version' .curl-upstream-state.json)
            UPSTREAM_PKGREL=$(jq -r '.last_pkgrel' .curl-upstream-state.json)
            LOCAL_VERSION=$(grep '^pkgver=' curl/APKBUILD | head -1 | cut -d= -f2)
            LOCAL_PKGREL=$(grep '^pkgrel=' curl/APKBUILD | head -1 | cut -d= -f2)

            echo "upstream_version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
            echo "upstream_pkgrel=$UPSTREAM_PKGREL" >> $GITHUB_OUTPUT
            echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT
            echo "local_pkgrel=$LOCAL_PKGREL" >> $GITHUB_OUTPUT

            if [ "$UPSTREAM_VERSION" != "$LOCAL_VERSION" ] || [ "$UPSTREAM_PKGREL" != "$LOCAL_PKGREL" ]; then
              echo "update_available=true" >> $GITHUB_OUTPUT
              echo "âœ… Update available: $LOCAL_VERSION-r$LOCAL_PKGREL -> $UPSTREAM_VERSION-r$UPSTREAM_PKGREL"
            else
              echo "update_available=false" >> $GITHUB_OUTPUT
              echo "âœ… Already up to date: $LOCAL_VERSION-r$LOCAL_PKGREL"
            fi
          fi

      - name: Apply update
        if: steps.check.outputs.update_available == 'true'
        run: |
          UPSTREAM_VERSION="${{ steps.check.outputs.upstream_version }}"
          UPSTREAM_PKGREL="${{ steps.check.outputs.upstream_pkgrel }}"

          echo "Applying update to $UPSTREAM_VERSION-r$UPSTREAM_PKGREL"
          ./scripts/apply-curl-update.sh "$UPSTREAM_VERSION" "$UPSTREAM_PKGREL"

      - name: Push branch and create PR
        if: steps.check.outputs.update_available == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          UPSTREAM_VERSION="${{ steps.check.outputs.upstream_version }}"
          UPSTREAM_PKGREL="${{ steps.check.outputs.upstream_pkgrel }}"
          LOCAL_VERSION="${{ steps.check.outputs.local_version }}"
          LOCAL_PKGREL="${{ steps.check.outputs.local_pkgrel }}"
          BRANCH_NAME="curl-update-$UPSTREAM_VERSION-r$UPSTREAM_PKGREL"

          # Push branch
          git push -u origin "$BRANCH_NAME"

          # Create PR with detailed description
          gh pr create \
            --title "Update curl to $UPSTREAM_VERSION-r$UPSTREAM_PKGREL" \
            --body "## ðŸ“¦ curl Update: $LOCAL_VERSION-r$LOCAL_PKGREL â†’ $UPSTREAM_VERSION-r$UPSTREAM_PKGREL

This PR was automatically generated by the curl update checker workflow.

### ðŸ”— Links
- [Alpine aports curl](https://gitlab.alpinelinux.org/alpine/aports/-/tree/master/main/curl)
- [curl upstream](https://curl.se/)
- [Upstream APKBUILD](/tmp/upstream-curl-APKBUILD) (check CI artifacts if available)

### âœ… Automated Changes
- [x] Updated \`pkgver\` to \`$UPSTREAM_VERSION\`
- [x] Updated \`pkgrel\` to \`$UPSTREAM_PKGREL\`
- [x] Synced patch files from Alpine aports
- [x] Updated \`sha512sums\`
- [x] Regenerated all variant Dockerfiles via \`apply-templates.sh\`

### âš ï¸ Manual Review Required
Please review the following sections that contain template conditionals:

- [ ] **depends_dev**: Check if changes affect PHP 8.0 vs 8.3+ conditionals
  - Current: Uses \`openssl1.1-compat-dev\` for PHP 8.0, \`openssl-dev>3\` for others
  - Current: Excludes \`nghttp2-dev\`, \`nghttp3-dev\` for PHP 8.0
- [ ] **checkdepends**: Check if \`nghttp2\` dependency changed
- [ ] **build() function**: Check configure flags, especially HTTP/2, HTTP/3, QUIC support
  - Current: Excludes \`--with-nghttp2\`, \`--with-nghttp3\`, \`--with-openssl-quic\` for PHP 8.0
- [ ] **New patches**: Review any new \`.patch\` files
- [ ] **Security fixes**: Check \`secfixes\` section for new CVEs

### ðŸ§ª Testing Checklist
- [ ] Build test for PHP 8.0 alpine variant (should NOT have nghttp2/nghttp3)
- [ ] Build test for PHP 8.3+ alpine variant (should have nghttp2/nghttp3)
- [ ] Verify curl version in built images: \`docker run <image> curl --version\`

### ðŸ“ Compare with Upstream
\`\`\`bash
# View upstream APKBUILD
curl -s 'https://gitlab.alpinelinux.org/api/v4/projects/alpine%2Faports/repository/files/main%2Fcurl%2FAPKBUILD?ref=master' | jq -r '.content' | base64 -d > /tmp/upstream-APKBUILD

# Diff with our template
diff -u curl/APKBUILD /tmp/upstream-APKBUILD
\`\`\`

---

**Generated by:** [check-curl-updates.yml](.github/workflows/check-curl-updates.yml)
**Date:** $(date -u +%Y-%m-%d\ %H:%M\ UTC)" \
            --label "dependencies,automated" \
            --assignee "${{ github.actor }}"

      - name: Commit state file
        if: always()
        run: |
          # Commit state file to default branch if it changed
          git checkout "${GITHUB_REF##*/}"
          git pull
          if [ -f .curl-upstream-state.json ]; then
            git add .curl-upstream-state.json
            if ! git diff --cached --quiet; then
              git commit -m "chore: update curl upstream state [skip ci]"
              git push
            fi
          fi